<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Store + Login</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <section id="login-section">
    <h2>Log In</h2>
    <form id="loginForm">
      <label>Username: <input type="text" name="username" required></label><br/>
      <label>Password: <input type="password" name="password" required></label><br/>
      <button type="submit">Log In</button>
    </form>
    <p id="login-error" style="color:red;"></p>
  </section>

  <!-- STORE SYSTEM (hidden until you’re logged in) -->
  <section id="app-section" style="display: none;">
    <header>
      <h1>Store Management System</h1>
      <button onclick="logout()" id="logoutBtn">Logout</button>
    </header>

    <main>
      <section id="product-form">
        <h2>Add Product</h2>
        <form id="addProductForm">
          <label for="name">Name:</label>
          <input type="text" id="name" name="name" required>

          <label for="price">Price:</label>
          <input type="number" id="price" name="price" required>

          <label for="quantity">Quantity:</label>
          <input type="number" id="quantity" name="quantity" required>

          <label for="category">Category:</label>
          <input type="text" id="category" name="category">

          <label for="description">Description:</label>
          <textarea id="description" name="description"></textarea>

          <button  id="submit" type="submit">Add Product</button>
        </form>
      </section>

      <section id="product-list">
        <h2>Products</h2>
        <table border="1" id="products-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Price (₹)</th>
              <th>Quantity</th>
              <th>Category</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody id="products-body">
            <!-- JS will insert rows here -->
          </tbody>
        </table>
      </section>      
    </main>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script >
    const API_URL = 'http://localhost:4000';
const loginForm = document.getElementById('loginForm');
const loginSection = document.getElementById('login-section');
const appSection   = document.getElementById('app-section');
const logoutBtn    = document.getElementById('logoutBtn');
const loginError   = document.getElementById('login-error');

document.getElementById("submit").addEventListener("click",addprod)

// On page load, decide which section to show:
document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('token');
  if (token) {
    // Already logged in
    showApp();
  } else {
    showLogin();
  }
});

async function addprod(event) {
  event.preventDefault();

  const product = {
    name: document.getElementById("name").value,
    price: document.getElementById("price").value,
    quantity: document.getElementById("quantity").value,
    category: document.getElementById("category").value,
    description: document.getElementById("description").value // ✅ fixed this line
  };

  console.log("called");

  const token = localStorage.getItem("token");

  try {
    const response = await axios.post(
      `${API_URL}/products`,
      product, // ✅ don't wrap it in `{ product }`
      {
        headers: {
          token: token // ✅ send token like this
        }
      }
    );

    alert("Product added successfully!");
    fetchProducts();
  } catch (err) {
    console.error("Failed to add product", err);
    alert("Failed to add product");
  }
}

  


// Show login screen
function showLogin() {
  loginSection.style.display = '';
  appSection.style.display   = 'none';
}

function logger(){
  console.log("hehe");
}

// Show store UI
function showApp() {
  loginSection.style.display = 'none';
  appSection.style.display   = '';
  // Initialize your product-fetching, form-hooks, etc.
}

async function fetchProducts() {
  const token = localStorage.getItem("token");
  try {
    const response = await axios.get(`${API_URL}/products`, {
      headers: { token },
    });

    const products = response.data;
    const tbody = document.getElementById("products-body");
    tbody.innerHTML = ""; // Clear existing rows

    products.forEach(product => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${product.name}</td>
        <td>${product.price}</td>
        <td>${product.quantity}</td>
        <td>${product.category}</td>
        <td>${product.description}</td>
      `;
      tbody.appendChild(row);
    });
  } catch (err) {
    console.error("Failed to fetch products", err);
  }
}



// Trigger fetch on page load
document.addEventListener('DOMContentLoaded', fetchProducts);

// Handle login form submit
loginForm.addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(loginForm);
  const credentials = {
    username: formData.get('username'),
    password: formData.get('password')
  };

  try {
    const res = await axios.post(`${API_URL}/login`, credentials);
    localStorage.setItem('token', res.data.token);
    loginError.textContent = '';
    showApp();
  } catch (err) {
    console.log("error");
  }
});

function logout(){
  localStorage.removeItem('token');
  showLogin();
}

// (Re-use your existing addprod + fetchProducts here, just
//  always include the stored token in the Authorization header.)

  </script>
</body>
</html>
